jQuery.extend(jQuery.browser,{SafariMobile :navigator.userAgent.toLowerCase().match(/iP(hone|ad)/i)});


var map = new BMap.Map("mapCanves",{enableMapClick: false});
window.map=map;
map.centerAndZoom(new BMap.Point(116.457341,39.896956), 12);

addMapControl();

map.enableScrollWheelZoom();

setMoveZoom();

var isShowEvent = true;


var oLeftList=$('#result_total');
var oLeftListTop=$('#loupan_box');

//map.addEventListener("load",showEventMarkers)//map.dragend end

var status='';
var listNumFlag=0;
$('#slideLeftBar li').click(function(){
    status = $(this).attr('class');	
    
    $.cookie('LNG','');
    $.cookie('LAT','');
    $.cookie('KEYWORDS','');
    //$.cookie('WALK_TIME','');
});

var oMapLoading = $('#mapLoading');
var oListLoading = $('#listLoading');
// 创建地址解析器实例
var myGeo = new BMap.Geocoder();
var friendPoint = [];//存男女的坐标
var centerPoint = [];//存中心点的坐标
var oMan = $('#manVal');
var oWoman = $('#womanVal');


var pointA,pointB;
// 复杂的自定义覆盖物
function intMap(k)
{    
     //removeMoveZoom();
      intListShow();
     //初始化左侧列表
   
     if(k==0)
	 {
	    isShowEvent = true;
            map.centerAndZoom(new BMap.Point(116.401454,39.957754), 12);
		
	 }
	 
   
     $.ajax({
			type:'GET',
			url:'http://www.ziroom.com/index.php?_p=map&_a=index',
			dataType:'json',
			success:function(data)
                        {
                                var ponitArr=[];
                                for(var i=0; i<data.length;i++)
                                {
                                        var txt = data[i].title;
                                        var point2=data[i].point;
                                        var point=new BMap.Point(getlng(point2),getlat(point2));
                                        ponitArr.push(point);
                                        addiintMarker(txt,point)
                                }
                                //map.setViewport(ponitArr);
                                ponitArr=null;
                }
	})   
	
	
}
intMap(1);


function deletePoint(txt,house_count){
  var text=txt+house_count;
  //console.log($('#mapCanves .msg').size());
  $('#mapCanves .msg').each(function(){

    var str = $(this).html();
//console.log(str+'==='+text);
    if(str.indexOf(text)!=-1){
      //console.log(str+'==='+text);
      $(this).parents('.red_pos').remove();
    }
  });   
}

/*---------------------------------------商圈自定义覆盖物类beigin--------------------------------------------*/
function ComplexCustomOverlay(txt,point,projectcode,house_count){

  this._point = point;
  this._text = txt;
  this._projectcode = projectcode;
  this._house_count = house_count;
}
ComplexCustomOverlay.prototype = new BMap.Overlay();
ComplexCustomOverlay.prototype.initialize = function(map){
   
  this._map = map;

  var div = this._div = document.createElement("div");  
  div.setAttribute('class','red_pos pos_icon');
  div.style.zIndex = BMap.Overlay.getZIndex(this._point.lat)-1000000;
  
  var that = this;

  var arrow = this._arrow = document.createElement("div");
  
  arrow.style.position = "absolute";
  arrow.style.width = "0px";
  arrow.style.height = "0px";
  arrow.style.top = "0px";
  arrow.style.left = "0px";
  arrow.style.overflow = "hidden";
  arrow.style.zIndex = "10";
  
	var mid_div=this._mid_div=document.createElement("div");
       
	mid_div.style.height = "23px";
	mid_div.style.width = "auto";
	mid_div.style.position = "";
	mid_div.style.top = "0px";
	mid_div.style.left = "0px";
	
	
 
 	
	div.appendChild(mid_div);
 
 	var span = this._span = document.createElement("span");
	  mid_div.appendChild(span);
	  span.appendChild(document.createTextNode(that._house_count));      
 
       var oDiv = document.createElement('div');
        mid_div.appendChild(oDiv);
        //oDiv.innerHTML=that._overText+'<b class="icon"><b>';
        oDiv.innerHTML='<span>'+that._text+ that._house_count +'套</span>'+'<b class="icon"><b>';
        oDiv.setAttribute('class','msg');
        



  
  var that = this;
  
   deletePoint(that._text,that._house_count);

if($.browser.SafariMobile)
{
  $(div).live('touchend',function (){
       xqClick(this);
  });//click end
}
else
{
   // div.addEventListener('click',xqClick);
  $(div).live('click',function (){
    xqClick(this);
  });//click end
  
  
  
}


 
 
function xqClick(a)
{
         var jg = $.cookie('PSNO');//价格区间
        var js = $.cookie('JSNO');//居室区间
        var zu = $.cookie('TYNO');//租住方式
        //
        //
        //
        //获取当前地图区域的坐标范围进行房源筛选
        var xinan = new Array();
            xinan = getBounds()[0];
	var xibei = new Array();
            xibei = getBounds()[1];
	var dongbei = new Array();
            dongbei  = getBounds()[2];
	var dongnan = new Array();
            dongnan = getBounds()[3];
	
		//var projectcode = "1号线";
                var projectcode = that._projectcode;
                $.cookie('projectcode',projectcode);//租住方式

                var lp_name = $(a).find("h3").text();
                var lp_price = $(a).find("span[id=price]").text();
                var station_name = $(a).find("span[id=station_name]").text();
                var walktimes = $(a).find("span[id=walktimes]").text();
                var house_address = $(a).find("span[id=house_address]").text();
                oListLoading.show();

               
		$.ajax({
			type:'GET',
				  data:{"projectcode":projectcode,"jg":jg,"js":js,"xn":xinan,"xb":xibei,"dnn":dongnan,"db":dongbei,"p":1,"zu":zu},
				   url:'http://www.ziroom.com/index.php?_p=map&_a=room',
				   dataType:'json',
				   success:function(data){
                                       oListLoading.hide();
                                              
				   	setDataLeft(data);
                                      
                                              
				   }
		});
		
		
		

}
 
  
  
 

  map.getPanes().markerMouseTarget.appendChild(div);
  
  return div;
}


ComplexCustomOverlay.prototype.draw = function(){
  var map = this._map;
  var pixel = map.pointToOverlayPixel(this._point);
  this._div.style.left = pixel.x - parseInt(this._arrow.style.left) + "px";
  this._div.style.top  = pixel.y - 30 + "px";
}

function setDataLeft(data){
    
   var _html = '';    
   var bizcircle_name = '';//城区
   var district_name='';//商圈
   var subway_line_code='';//地铁线
   var subway_station_code='';//地铁站
   var t_walking_time='';//时间
   var resblock_name ='';//楼盘名字
   var dispose_bedroom_amount = '';//居室
   var index_no = '';
   var house_facing = '';
   var compartment_face = '';
  
   
    
    if(data.list.length===0){
        //如果没有对应房源
       var errmes = "";
       if($.cookie('KEYWORDS')=="") errmes="您的条件";
       else errmes = $.cookie('KEYWORDS');
        _html += '<div class="none_msg">'
    	+'	<div class="tc"><img src="p.png"/*tpa=http://www.ziroom.com/static/2015/images/list/none/p.png*/></div>'
    	+'		<p class="fs16 mb40 tc">很抱歉，没有找到与<span class="org">“'+errmes+'”</span>相关的房源</p>'
        +'		</div>';
     // $.cookie('KEYWORDS','');
    }
    
    
    
    
    for(var i=0; i<data.list.length; i++){
        
        
        //城区
        if(data.list[i].bizcircle_name!=null){
             if(data.list[i].bizcircle_name.constructor==Array){               
                bizcircle_name = data.list[i].bizcircle_name[0];
            }else{
                 bizcircle_name = data.list[i].bizcircle_name;
            }
        } else{
            bizcircle_name='';
        }  
        //商圈
        if(data.list[i].district_name!=null){
             if(data.list[i].district_name.constructor==Array){               
                district_name = data.list[i].district_name[0];
            }else{
                 district_name = data.list[i].district_name;
            }
        } else{
            district_name='';
        }    
        
        //地铁线
        if(data.list[i].subway_line_code!=null){
             if(data.list[i].subway_line_code.constructor==Array){               
                subway_line_code = data.list[i].subway_line_code[0];
            }else{
                 subway_line_code = data.list[i].subway_line_code;
            }
        } else{
            subway_line_code='';
        }  
        
        //地铁站
        if(data.list[i].subway_station_code!=null){
             if(data.list[i].subway_station_code.constructor==Array){               
                subway_station_code = data.list[i].subway_station_code[0];
            }else{
                 subway_station_code = data.list[i].subway_station_code;
            }
        } else{
            subway_station_code='';
        }  
        
        
        if(data.list[i].walking_distance_dt!=null){
            
           
            if(data.list[i].walking_distance_dt.constructor==Array){
               
                t_walking_time = data.list[i].walking_distance_dt[0];
            }else{
                 t_walking_time = data.list[i].walking_distance_dt;
            }
        }else{
            t_walking_time='';
        }  
        
        if(data.list[i].resblock_name!=null){
            resblock_name = data.list[i].resblock_name;
        }else{
            resblock_name = '';
        }
        if(data.list[i].dispose_bedroom_amount!=null){
            dispose_bedroom_amount = data.list[i].dispose_bedroom_amount;
        }else{
            dispose_bedroom_amount = '';
        }
        index_no = data.list[i].index_no;
        
        if(data.list[i].house_facing!=null){
            house_facing = data.list[i].house_facing;
        }else{
            house_facing = '';
        }

        if(data.list[i].compartment_face!=null){
            compartment_face = data.list[i].compartment_face;
        }else{
            compartment_face = '';
        }

        var p2 = district_name+''+resblock_name;
        
        if(status=='office' && $.cookie('WALK_TIME')>0 && gjTime.length==data.list[i].length){
            
                getGjTime($('#i_q_keyword_2').val(),p2);
                
               
                if(parseInt(gjTime[i]) <= parseInt($.cookie('WALK_TIME'))){
                   // console.log('符合的是：'+p2);
                    setList(data,i);
                }
                
         
        }else{
           setList(data,i);
        }
       
            
    }
    
   
    
      
 function setList(data,i){
    
           _html+='<li class="clearfix">'
            _html+='<div class="img">'
            
            var imagepath = data.list[i].imagepath;
            
            var imgSrc= 'yuanwei-up.jpg'/*tpa=http://www.ziroom.com/static/2015/js/map/yuanwei-up.jpg*/;
            var picUrl = 'http://pic.ziroom.com/house_images/'+imagepath;
            var imgUrl = 'http://www.ziroom.com/static/images/slist_1207/';
             
            
            if(imagepath==null){
              picUrl = imgUrl+imgSrc;
            }
            if(data.list[i].is_whole=='1'){
                imgSrc= 'zhengzu-up.jpg'/*tpa=http://www.ziroom.com/static/2015/js/map/zhengzu-up.jpg*/;
            }else{
                if(data.list[i].style_code=='97001001'){
                  imgSrc= 'natie-up.jpg'/*tpa=http://www.ziroom.com/static/2015/js/map/natie-up.jpg*/;
                }else if(data.list[i].style_code=='97001002'){
                  imgSrc= 'mumian-up.jpg'/*tpa=http://www.ziroom.com/static/2015/js/map/mumian-up.jpg*/;
                }else if(data.list[i].style_code=='97001003'){
                  imgSrc= 'buding-up.jpg'/*tpa=http://www.ziroom.com/static/2015/js/map/buding-up.jpg*/;
                }else if(data.list[i].style_code=='97001004'){
                   imgSrc= 'yuanwei-up.jpg'/*tpa=http://www.ziroom.com/static/2015/js/map/yuanwei-up.jpg*/;
                }else if(data.list[i].style_code=='97001005'){
                   imgSrc= 'misu-up.jpg'/*tpa=http://www.ziroom.com/static/2015/js/map/misu-up.jpg*/;
                }else{
                   imgSrc= 'yuanwei-up.jpg'/*tpa=http://www.ziroom.com/static/2015/js/map/yuanwei-up.jpg*/;
                }
               
            }
            _html+='<a href="http://www.ziroom.com/z/vr/%27+ data.list[i].room_id +%27.html"'
            +' target="_blank">'
            +'<img width="136" height="85"'
            +' onerror="this.src=\''+imgUrl+imgSrc+'\'"  src="'+picUrl+'"></a>';

            if(data.list[i].is_whole=='1'){
                if(house_facing==''){
                    _html+='</div>'
                    _html+='<div class="txt">'
                    _html+='<h3><a href="http://www.ziroom.com/z/vr/%27+ data.list[i].room_id +%27.html" target="_blank" title="'+resblock_name+''+dispose_bedroom_amount+'居室'+house_facing+'">'
                    _html+='<p class="subtit"><a href="http://www.ziroom.com/z/vr/%27+ data.list[i].room_id +%27.html" target="_blank" title="'+ district_name +' '+ bizcircle_name +'">'
                    _html+=resblock_name+''+dispose_bedroom_amount+'居室'+house_facing+'</a></h3>'
                    _html+='<p class="subtit"><a href="http://www.ziroom.com/z/vr/%27+ data.list[i].room_id +%27.html" target="_blank" title="'+ district_name +' '+ bizcircle_name +'">'
                    _html+='['+district_name +''+ bizcircle_name +']'
                }else{
                    _html+='</div>'
                    _html+='<div class="txt">'
                    _html+='<h3><a href="http://www.ziroom.com/z/vr/%27+ data.list[i].room_id +%27.html" target="_blank" title="'+resblock_name+''+dispose_bedroom_amount+'居室-'+house_facing+'">'
                    _html+='<p class="subtit"><a href="http://www.ziroom.com/z/vr/%27+ data.list[i].room_id +%27.html" target="_blank" title="'+ district_name +' '+ bizcircle_name +'">'
                    _html+=resblock_name+''+dispose_bedroom_amount+'居室-'+house_facing+'</a></h3>'
                    _html+='<p class="subtit"><a href="http://www.ziroom.com/z/vr/%27+ data.list[i].room_id +%27.html" target="_blank" title="'+ district_name +' '+ bizcircle_name +'">'
                    _html+='['+district_name +''+ bizcircle_name +']'
                }
            }else{
                if(compartment_face==''){
                    _html+='</div>'
                    _html+='<div class="txt">'
                    _html+='<h3><a href="http://www.ziroom.com/z/vr/%27+ data.list[i].room_id +%27.html" target="_blank" title="'+resblock_name+''+dispose_bedroom_amount+'居室'+compartment_face+'">'
                    _html+='<p class="subtit"><a href="http://www.ziroom.com/z/vr/%27+ data.list[i].room_id +%27.html" target="_blank" title="'+ district_name +' '+ bizcircle_name +'">'
                    _html+=resblock_name+''+dispose_bedroom_amount+'居室'+compartment_face+'</a></h3>'
                    _html+='<p class="subtit"><a href="http://www.ziroom.com/z/vr/%27+ data.list[i].room_id +%27.html" target="_blank" title="'+ district_name +' '+ bizcircle_name +'">'
                    _html+='['+district_name +''+ bizcircle_name +']'
                }else{
                    _html+='</div>'
                    _html+='<div class="txt">'
                    _html+='<h3><a href="http://www.ziroom.com/z/vr/%27+ data.list[i].room_id +%27.html" target="_blank" title="'+resblock_name+''+dispose_bedroom_amount+'居室-'+compartment_face+'卧">'
                    _html+='<p class="subtit"><a href="http://www.ziroom.com/z/vr/%27+ data.list[i].room_id +%27.html" target="_blank" title="'+ district_name +' '+ bizcircle_name +'">'
                    _html+=resblock_name+''+dispose_bedroom_amount+'居室-'+compartment_face+'卧</a></h3>'
                    _html+='<p class="subtit"><a href="http://www.ziroom.com/z/vr/%27+ data.list[i].room_id +%27.html" target="_blank" title="'+ district_name +' '+ bizcircle_name +'">'
                    _html+='['+district_name +''+ bizcircle_name +']'
                }
            }
            if(data.list[i].is_whole!='0'){
                if(data.list[i].duanzuFlag!='0'){
                    _html+=subway_line_code + subway_station_code +'</a><span class="icons">整</span><span class="icons">月</span>'
                }else{
                    _html+=subway_line_code + subway_station_code +'</a><span class="icons">整</span>'
                }
            }else{
                if(data.list[i].duanzuFlag!='0'){
                    _html+=subway_line_code + subway_station_code +'</a><span class="icons">合</span><span class="icons">月</span>'
                }else{
                    _html+=subway_line_code + subway_station_code +'</a><span class="icons">合</span>'
                }
            }
            _html+='</p><p class="p"><span class="price">'+ data.list[i].rent_fee+'</span><span class="gray-9">(每月)</span></p>'
            _html+='<p class="room_tags clearfix">';

	    if(data.list[i]. walking_distance_dt!=''){
	            if(data.list[i]. subway_ten=='1'){
	              _html+=' <span class="subway">地铁10分钟</span>'
                }
            }

            if(data.list[i].is_whole=='1'){
                if(data.list[i].style_code=='97001006'){
                    _html+=' <span class="style">深色系</span>'
                }else if(data.list[i].style_code=='97001007'){
                    _html+=' <span class="style">浅色系</span>'
                }else{
                    _html+=' <span class="style">原味</span>'
                }
            }

            if(data.list[i].is_whole=='0'){
                if(data.list[i].toliet_exist=='Y'){
                  _html+=' <span class="toilet">独卫</span>'
                }
                if(data.list[i].balcony_exist=='Y'){
                    _html+=' <span class="balcony">独立阳台</span>'
                }
            }
            if(data.list[i].is_whole=='0'){
                if (data.list[i].ziroom_version_id == '1001'){
                    if (data.list[i].style_code == '97001001'){
                        _html+='<a href="http://www.ziroom.com/index.php?_p=nlist&_a=product" target="_blank"  class="style">2.0拿铁</a>'
                    }else if(data.list[i].style_code == '97001002'){
                        _html+='<a href="http://www.ziroom.com/index.php?_p=nlist&_a=product" target="_blank"  class="style">2.0 木棉</a>'
                    }else if(data.list[i].style_code== '97001003'){
                        _html+='<a href="http://www.ziroom.com/index.php?_p=nlist&_a=product" target="_blank" class="style">2.0 布丁</a>'
                    }else{
                        _html+='<a href="http://www.ziroom.com/index.php?_p=nlist&_a=product" target="_blank"  class="style">2.0 原味</a>'
                    }
                }else if(data.list[i].ziroom_version_id == '1003'){
                    if (data.list[i].style_code == '97001001'){
                        _html+='<a href="http://www.ziroom.com/zhuanti/youjia3/index.html" target="_blank"  class="style">3.0拿铁</a>'
                    }else if(data.list[i].style_code == '97001002'){
                        _html+='<a href="http://www.ziroom.com/zhuanti/youjia3/index.html" class="style">3.0 木棉</a>'
                    }else if(data.list[i].style_code== '97001003'){
                        _html+='<a href="http://www.ziroom.com/zhuanti/youjia3/index.html" class="style">3.0 布丁</a>'
                    }else{
                        _html+='<a href="http://www.ziroom.com/zhuanti/youjia3/index.html" class="style">3.0 米苏</a>'
                   }
                }else{
                    _html+='<span class="style">1.0 原味</span>'
                }
            }
            +'</p>' 	
            +'</div>'
            +'</li>';
      


}       
  oLeftList.html(_html);
  
  if(oLeftList.html()==''&& $.cookie('WALK_TIME')>0){              
        //如果没有对应房源
       var errmes = "";
       if($.cookie('KEYWORDS')=="") errmes="您的条件";
       else errmes = $.cookie('KEYWORDS');
        _html += '<div class="none_msg">'
        +'	<div class="tc"><img src="p.png"/*tpa=http://www.ziroom.com/static/2015/images/list/none/p.png*/></div>'
        +'		<p class="fs16 mb40 tc">很抱歉，没有找到与<span class="org">“'+errmes+'”</span>相关的房源</p>'
        +'		</div>';
        $.cookie('KEYWORDS','');
        
        oLeftList.html(_html);

    }
  
  
  
if(data.pager){
    $('#page').html(data.pager);
}else{
    $('#page').html('');
}

  


 }




//左侧列表显示房源（每次调用）
function ListShow()
{
        
        
        var opoint = "";
        var opoint2 = "";
        var opoint3 = "";
        var opoint4 = "";
        var opoint5 = "";
       
        var jg = $.cookie('PSNO');//价格区间
        var js = $.cookie('JSNO');//居室区间
        var zu = $.cookie('TYNO');//租住方式
        //
        //
        //
        //获取当前地图区域的坐标范围进行房源筛选
        var xinan = new Array();
            xinan = getBounds()[0];
	var xibei = new Array();
            xibei = getBounds()[1];
	var dongbei = new Array();
            dongbei  = getBounds()[2];
	var dongnan = new Array();
            dongnan = getBounds()[3];
        
        opoint = $.cookie('SUBWAYLINE_NAME');//地铁线路名称
        if(opoint==""){
            //如果选择的不是地铁线路
            opoint2 = $.cookie('STATION_NAME');//地铁站名称
            if(opoint==""){
                //如果也不是地铁站
                opoint3 = $.cookie('BD_NAME');//行政区名称
                if(opoint==""){
                    //如果也不是行政区
                    opoint4 = $.cookie('BBD_NAME');//商圈区名称 
                    if(opoint=="")
                        //如果都不是，那就是用户输入搜索词
                        opoint5 = "building";
                        //$.cookie('KEYWORDS','');//用户搜索词 
                       //if(opoint4==""&&opoint3=="") opoint4 = $.cookie('KEYWORDS');//用户搜索词 
                       if($.cookie('KEYWORDS')) opoint4 = $.cookie('KEYWORDS');//用户搜索词
                    
                }
                
            }
        }

        
        oLeftList.html('');       
        oListLoading.show();
        $.ajax({
            type:'POST',
            data:{"dn":opoint3,"bn":opoint4,"slc":opoint,"ssc":opoint2,"jg":jg,"js":js,"xn":xinan,"xb":xibei,"dnn":dongnan,"db":dongbei,"p":1,"zu":zu},
            url:'http://www.ziroom.com/index.php?_p=map&_a=rooms',
            dataType:'json',
            success:function(data){
                oListLoading.hide();
                setDataLeft(data);
            },
            error:function(){
               
            }
        });
		
		
		

}


//左侧列表显示房源（初始化）
function intListShow()
{
        
        var opoint = "";//地铁线路名称
        var opoint2 = "";//地铁站名称
        var opoint3 = "";//行政区名称
        var opoint4 = "";//商圈区名称 
        var opoint5 = ""; //用户输入搜索词
            
        
        oListLoading.show();
		
        $.ajax({
                type:'POST',
                data:{"dn":opoint3,"bn":opoint4,"slc":opoint,"ssc":opoint2,"p":1},
                url:'http://www.ziroom.com/index.php?_p=map&_a=rooms',
                dataType:'json',
                success:function(data){
                    oListLoading.hide();
                    setDataLeft(data);		
                },
            error:function(){
                
            }
        });
}
 
function showPage(p,j,a)
{
    
      var jg = $.cookie('PSNO');//价格区间
        var js = $.cookie('JSNO');//居室区间
        var zu = $.cookie('TYNO');//租住方式
        //
        //
        //
        //获取当前地图区域的坐标范围进行房源筛选
        var xinan = new Array();
            xinan = getBounds()[0];
	var xibei = new Array();
            xibei = getBounds()[1];
	var dongbei = new Array();
            dongbei  = getBounds()[2];
	var dongnan = new Array();
            dongnan = getBounds()[3];
   
   var projectcode = $.cookie('projectcode');
   oListLoading.show();
   $.ajax({
        type:'GET',
       // data:{"projectcode":projectcode,"p":p,"j":j,"a":a},
        data:{"projectcode":projectcode,"jg":jg,"js":js,"xn":xinan,"xb":xibei,"dnn":dongnan,"db":dongbei,"p":p,"zu":zu},
        url:'http://www.ziroom.com/index.php?_p=map&_a=room',
        dataType:'json',
        success:function(data)
        {
            oListLoading.hide();
            setDataLeft(data);
       }
    })
}

function showPages(p,j,a)
{
   var opoint = "";
        var opoint2 = "";
        var opoint3 = "";
        var opoint4 = "";
        var opoint5 = "";
         //获取当前地图区域的坐标范围进行房源筛选
        var xinan = new Array();
            xinan = getBounds()[0];
	var xibei = new Array();
            xibei = getBounds()[1];
	var dongbei = new Array();
            dongbei  = getBounds()[2];
	var dongnan = new Array();
            dongnan = getBounds()[3];
        opoint = $.cookie('SUBWAYLINE_NAME');//地铁线路名称
        if(opoint==""){
            //如果选择的不是地铁线路
            opoint2 = $.cookie('STATION_NAME');//地铁站名称
            if(opoint==""){
                //如果也不是地铁站
                opoint3 = $.cookie('BD_NAME');//行政区名称
                if(opoint==""){
                    //如果也不是行政区
                    opoint4 = $.cookie('BBD_NAME');//商圈区名称 
                    if(opoint=="")
                        //如果都不是，那就是用户输入搜索词
                        opoint5 = "building";
                }
                
            }
        }
        
        var jg = $.cookie('PSNO');//价格区间
        var js = $.cookie('JSNO');//居室区间
        var zu = $.cookie('TYNO');//租住方式
        var projectcode = $("#projectname").attr('projectcode');

        $.ajax({
            type:'POST',
            data:{"projectcode":projectcode,"dn":opoint3,"bn":opoint4,"slc":opoint,"ssc":opoint2,"p":p,
            "j":j,"xn":xinan,"xb":xibei,"dnn":dongnan,"db":dongbei,"a":a,"jg":jg,"js":js,"zu":zu},
            url:'http://www.ziroom.com/index.php?_p=map&_a=rooms',
            dataType:'json',
            success:function(data)
            {
                setDataLeft(data);
           },
            error:function(){
                
            }
	});
}



//地铁写字楼名称
function showBuilding(id,house_name,location)
{       
    isShowEvent = false;
    var loglnt = location.split(',');
    var lng = loglnt[0];
    var lat = loglnt[1];
    var markName=house_name;
    var point=new BMap.Point(lng,lat);
    addSubwayMarker(markName,point,id);

}
function addSubwayMarker(t_txt,t_point,station_id){
	  var myCompOverlay = new BuildOverlay(t_point, t_txt,station_id)
	  map.addOverlay(myCompOverlay);
	}
/*---------------------------------------商圈自定义覆盖物类 end--------------------------------------------*/

/*---------------------------------------初始化时商圈自定义覆盖物类 begin-----------------------------------------*/
function initOverlay(point, text){
  this._point = point;
  this._text = text;
}

initOverlay.prototype = new BMap.Overlay();
initOverlay.prototype.initialize = function(map){
  this._map = map;
  var div = this._div = document.createElement("div");
  div.style.position = "absolute";
  div.style.zIndex = BMap.Overlay.getZIndex(this._point.lat)+1000000;
  div.style.color = "#fff";
  div.style.fontWeight = "bold";
  div.style.width = "93px";
  div.style.height = "64px";
  div.style.paddingTop = "35px";
  div.style.textAlign="center",
  div.style.lineHeight = "18px";
  div.style.whiteSpace = "nowrap";
  div.style.MozUserSelect = "none";
  div.style.fontSize = "14px";
  div.style.background = "url(/static/2015/images/map/img/yuan.png)  no-repeat center center";
  var that = this;

  var arrow = this._arrow = document.createElement("div");
	 
	  arrow.style.position = "absolute";
	  arrow.style.width = "17px";
	  arrow.style.height = "8px";
	  arrow.style.top = "34px";
	  arrow.style.left = "10px";
	  arrow.style.overflow = "hidden";
	  arrow.style.zIndex = "10";
  
	var mid_div=this._mid_div=document.createElement("div");
	
	mid_div.style.height = "35px";
	mid_div.style.width = "auto";
	mid_div.style.position = "";
	mid_div.style.top = "0px";
	mid_div.style.left = "7px";
	
	
 
    div.appendChild(arrow);
	div.appendChild(mid_div);
	
 	var span = this._span = document.createElement("span");
	span.style.display = "block";
	span.style.padding = "0px 6px";
	
	  mid_div.appendChild(span);
	  span.appendChild(document.createTextNode(this._text));      
	  
 
  mid_div.onmouseover = function(){
	this.parentNode.style.zIndex = BMap.Overlay.getZIndex( - 1000);
	arrow.style.backgroundPosition = "";
  }

  mid_div.onmouseout = function(){
	this.parentNode.style.zIndex = BMap.Overlay.getZIndex(that._point.lat)+1000000;
	arrow.style.backgroundPosition = "0px 0px";
  }
    var that=this;
    if($.browser.SafariMobile)
    {
      $(div).live('touchend',function (){
                    sqClick();
      });//click end
    }
    else
    {
      $(div).live('click',function (){
        sqClick();
      });//click end
    }  
  
    function sqClick(){
        isShowEvent = false;
        map.clearOverlays();
        removeMoveZoom();
        //oMapLoading.show();
        var centerPonit=new BMap.Point(that._point.lng,that._point.lat);
        map.centerAndZoom(centerPonit, 15);
        setMoveZoom();
        getMapData(map.getZoom,$.cookie('PSNO'),$.cookie('JSNO'),$.cookie('TYNO'));
        
       
    }

    map.getPanes().markerMouseTarget.appendChild(div);
    return div;
}
initOverlay.prototype.draw = function(){
  var map = this._map;
  var pixel = map.pointToOverlayPixel(this._point);
  this._div.style.left = pixel.x - parseInt(this._arrow.style.left) + "px";
  this._div.style.top  = pixel.y - 30 + "px";
}

/*---------------------------------------初始化时商圈自定义覆盖物类 end--------------------------------------------*/


/*---------------------------------------打情侣两个人的点 begin-----------------------------------------*/
function initLoveOverlay(point, text){
  this._point = point;
  this._text = text;
}

initLoveOverlay.prototype = new BMap.Overlay();
initLoveOverlay.prototype.initialize = function(map){
  this._map = map;
  var div = this._div = document.createElement("div");
  div.setAttribute('class','red_pos pos_icon green_pos');
  div.style.zIndex = BMap.Overlay.getZIndex(this._point.lat)-1000000;
  
  var that = this;

  var arrow = this._arrow = document.createElement("div");
  
  arrow.style.position = "absolute";
  arrow.style.width = "0px";
  arrow.style.height = "0px";
  arrow.style.top = "0px";
  arrow.style.left = "0px";
  arrow.style.overflow = "hidden";
  arrow.style.zIndex = "10";
  
	var mid_div=this._mid_div=document.createElement("div");
       
	mid_div.style.height = "23px";
	mid_div.style.width = "auto";
	mid_div.style.position = "";
	mid_div.style.top = "0px";
	mid_div.style.left = "0px";
	
	
 
 	
	div.appendChild(mid_div);
 
 	var span = this._span = document.createElement("span");
	  mid_div.appendChild(span);
	  span.appendChild(document.createTextNode(this._text));      
 
 /*
       var oDiv = document.createElement('div');
        mid_div.appendChild(oDiv);
        //oDiv.innerHTML=that._overText+'<b class="icon"><b>';
        oDiv.innerHTML='<span>就为了测试</span>'+'<b class="icon"><b>';
        oDiv.setAttribute('class','msg');*/
	  


    map.getPanes().markerMouseTarget.appendChild(div);
    return div;
}
initLoveOverlay.prototype.draw = function(){
  var map = this._map;
  var pixel = map.pointToOverlayPixel(this._point);
  this._div.style.left = pixel.x - parseInt(this._arrow.style.left) -10 + "px";
  this._div.style.top  = pixel.y - 30 + "px";
}

/*---------------------------------------初始化时商圈自定义覆盖物类 end--------------------------------------------*/



function clearMarkers(){
    var bounds = map.getBounds();
    var allOverlays=map.getOverlays();
    for(var i=1;i<allOverlays.length;i++){
        var point=allOverlays[i]._point;
        if(!bounds.containsPoint(point))
        {
                map.removeOverlay(allOverlays[i]);
        }
    }//for end
}

function addMarker(txt,point,projectcode,house_count){
	          
    var myCompOverlay = new ComplexCustomOverlay(txt,point,projectcode,house_count)
	  map.addOverlay(myCompOverlay);
          
          
          
}


function addiintMarker(t_txt,t_point){
	  var myCompOverlay = new initOverlay(t_point, t_txt);
	  map.addOverlay(myCompOverlay);
	}

function showLoverMarker()
{   
   $.cookie('LNG','');
   $.cookie('LAT','');
    
    isShowEvent = false;
    var nFlag = $('#nFlag').val();
    map.clearOverlays();
    
    geoPointMarker('#manVal',$('#manVal').val(),function(){
        geoPointMarker('#womanVal',$('#womanVal').val(),function(){
            
            
             
             if(oMan.attr('data-lng')!='' && oMan.attr('data-lat')!='' && oWoman.attr('data-lng')!='' && oWoman.attr('data-lat')!=''){
                    //oMapLoading.show();
                  
                    //clearMarkers();         

                    pointA = new BMap.Point(oMan.attr('data-lng'),oMan.attr('data-lat'));  // 男生位置
                    pointB = new BMap.Point(oWoman.attr('data-lng'),oWoman.attr('data-lat'));  // 女生位置


                    addLoveMarker('男',pointA);
                    addLoveMarker('女',pointB);    

                    if(nFlag==0){//当是中心点的时候
                        addLoveMarker('男',pointA);
                        addLoveMarker('女',pointB);
                        map.setViewport([pointA,pointB]); //调整最好视距，方便找中心点

                        centerPoint=[map.getCenter().lng,map.getCenter().lat];
                        center_lng = map.getCenter().lng;//存中心点的经度坐标
                        center_lat = map.getCenter().lat;//存中心点的经度坐标
                        $.cookie('LNG',center_lng);
                        $.cookie('LAT',center_lat);
                        
                         var s = center_lng+','+center_lat;
                         
                        setTimeout(function(){
                            setLoveMarker(center_lng,center_lat);
                        },100);
                        
                       
                            
                    }


                    if(nFlag==1){//当是男生的时候
                         $.cookie('LNG',oMan.attr('data-lng'));
                         $.cookie('LAT',oMan.attr('data-lat'));
                         map.centerAndZoom(pointA, 14);
                         
                         
                         var s = oMan.attr('data-lng')+','+oMan.attr('data-lat');
                         
                         
                         setTimeout(function(){
                            setLoveMarker( $.cookie('LNG'), $.cookie('LAT'));
                        },100);
                         
                    }

                    if(nFlag==2){//当是女生的时候
                        $.cookie('LNG',oWoman.attr('data-lng'));
                        $.cookie('LAT',oWoman.attr('data-lat'));
                         map.centerAndZoom(pointB, 14);
                         var s = oWoman.attr('data-lng')+','+oWoman.attr('data-lat');
                          
                          setTimeout(function(){
                            setLoveMarker( $.cookie('LNG'), $.cookie('LAT'));
                        },100);
                         
                    }


                }
        })
    });
    

}

function setLoveMarker(lng,lat){
    
    map.clearOverlays();
    if($.cookie('LNG')!='' && $.cookie('LAT')!=''){
        clearMarkers();
    
   
    $.ajax({
        type:'POST',
        data:{"center_lng":lng,"center_lat":lat,"p":1},
        url:'http://www.ziroom.com/index.php?_p=map&_a=show_lover',
        dataType:'json',
        success:function(data){
           //oMapLoading.hide();	
           
            for(var i=0; i<data.length;i++){

                    var txt = data[i].projectname;	
                    var projectcode = data[i].projectcode;
                    var lng = data[i].latitude;
                    var lat = data[i].longitude;
                    var point=new BMap.Point(lat,lng);                               
                    var house_counts = data[i].house_counts;
                    
                    addMarker(txt,point,projectcode,house_counts);  
                   

            }
        }
     });
     
      pointA = new BMap.Point(oMan.attr('data-lng'),oMan.attr('data-lat'));  // 男生位置
      pointB = new BMap.Point(oWoman.attr('data-lng'),oWoman.attr('data-lat'));  // 女生位置
     
    addLoveMarker('男',pointA);
    addLoveMarker('女',pointB);
    
    
    //pointC = new BMap.Point(lng,lat);  // 男生位置     
   // addLoveMarker('中',pointC);
    
    
     var polyline = new BMap.Polyline([pointA,pointB], {strokeColor:"red", strokeWeight:3, strokeOpacity:0.5});  //定义折线
             map.addOverlay(polyline);
    }
    
    
     
}



function addLoveMarker(t_txt,t_point){
	  var myCompOverlay = new initLoveOverlay(t_point, t_txt);
	  map.addOverlay(myCompOverlay);
	}

function getlng(data){
		var str=new Array();
		str=data.split(",");
		p_lng=str[0];
		return p_lng;
	}
function getlat(data){
		var str=new Array();
		str=data.split(",");
		p_lat=str[1];
		return p_lat;
	}

function createMap() {
	var map = new BMap.Map("map_canvas");
	var C = new BMap.Point(116.404, 39.915);
	map.centerAndZoom(C, 13);
	var A = new ZoomControl();
	B.addControl(A);
	window.map = B;
	B.enableScrollWheelZoom(true)
}//createMap end
function addMapControl() {
	var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_BOTTOM_RIGHT});// 左上角，添加比例尺
	var top_left_navigation = new BMap.NavigationControl();  //左上角，添加默认缩放平移控件
	var top_right_navigation = new BMap.NavigationControl({anchor: BMAP_ANCHOR_TOP_RIGHT, type: BMAP_NAVIGATION_CONTROL_SMALL}); //右上角，仅包含平移和缩放按钮
	
	
        map.addControl(top_left_control);        
        map.addControl(top_left_navigation);     
        map.addControl(top_right_navigation);    

	
       
        
}//addMapControl end

function getBounds(){
    var bounds = map.getBounds();
    var sw = bounds.getSouthWest();
    var ne = bounds.getNorthEast();
    var sw_lng=sw.lng;//最西经度
    var sw_lat=sw.lat;//最南纬度
    var ne_lng=ne.lng;//最东经度
    var ne_lat=ne.lat;//最北纬度
    var xinan=[sw_lng,sw_lat];//西南角
    var xibei=[sw_lng,ne_lat];//西北角
    var dongbei=[ne_lng,ne_lat];//东北角
    var dongnan=[ne_lng,sw_lat];//东南角
    var boundsArray=[xinan,xibei,dongbei,dongnan];
    return boundsArray;
}

function showMarkers(id,house_name,location,zoom,isshow)
{
    
       
	isShowEvent = false;
	removeMoveZoom();    
	$.cookie('index_location','');
	$.cookie('location_name','');
	//map.clearOverlays();
	
	
	
	$("#keyword").attr('keyword_point','');
	//oMapLoading.show();
	//var stationArray=[];
	var loglnt = location.split(',');
	var lng = loglnt[0];
	var lat = loglnt[1];
	map.centerAndZoom(new BMap.Point(lng,lat), zoom);
	setMoveZoom();      
	showBuilding(id,house_name,location);
        
        
	if(!isShowEvent) getMapData(map.getZoom,$.cookie('PSNO'),$.cookie('JSNO'),$.cookie('TYNO'));
        
	
        
}
function showBuildingMarkers(id,house_name,location,zoom,isshow)
{
    
       
	isShowEvent = false;
        //map.clearOverlays();
	removeMoveZoom();    
	$.cookie('index_location','');
	$.cookie('location_name','');
	
	
	
	
	$("#keyword").attr('keyword_point','');
	//oMapLoading.show();
	//var stationArray=[];
	var loglnt = location.split(',');
	var lng = loglnt[0];
	var lat = loglnt[1];
	map.centerAndZoom(new BMap.Point(lng,lat), 13);
	setMoveZoom();      
	showBuilding(id,house_name,location);
        
       // getBusTimesArray();
	 
        if(!isShowEvent) {
           // setTimeout(function(){
                getMapDataBuilding(13,$.cookie('PSNO'),$.cookie('JSNO'),$.cookie('TYNO'));
                
          //  },1000);
            
        }
	
        
       
        
        
}


function showEventMarkers(){
    if(isShowEvent) map.clearOverlays();
    else clearMarkers();
   
	//$.cookie('WALK_TIME','*');	
		if(isShowEvent)
		{
                   
			getMapData(map.getZoom,$.cookie('PSNO'),$.cookie('JSNO'),$.cookie('TYNO'));
                       
		}
		else{
                    
                     getMapData(map.getZoom,$.cookie('PSNO'),$.cookie('JSNO'),$.cookie('TYNO'));
                   
                     
                     
			
		}
    //if(status!='lovers'){
        // var locations = $.cookie('LNG')+','+$.cookie('LAT');
        //showBuilding('',$.cookie('KEYWORDS'),locations,15,"yes");
   // }
     
    
    
            var zoom=map.getZoom();
            if(zoom<12){
               zoom = 12;
               map.centerAndZoom("北京",12);
            }else{
                 //zoom = map.getZoom;
                 zoom = 14;
            }
             
}
function clearMapData()
{
    clearMarkers();
}
//设置移动活拖动函数
function setMoveZoom()
{
	map.addEventListener("zoomend",showEventMarkers)//map.zoomend end
        map.addEventListener("moveend",showEventMarkers)//map.dragend end	
}

//删除移动活拖动函数
function removeMoveZoom()
{
    window.map.removeEventListener("zoomend",showEventMarkers)//map.zoomend end
    window.map.removeEventListener("moveend",showEventMarkers)//map.dragend end	
}

//获取地图数据
function getMapData(limit,psno,jsno,tyno)
{
       isShowEvent = false;
      // map.clearOverlays();
	if(limit>16) limit = '';
	else limit = 30;
        opoint = $.cookie('STATION_NAME');//地铁站名称
        if(opoint=="") opoint = "building";
        
      // oMapLoading.show();
        
     if(status=='lovers' || status=='office'){
           
           if(status=='lovers'){
                setTimeout(function(){
                    if($.cookie('LNG')!='' && $.cookie('LAT')!='' ){
                         setLoveMarker($.cookie('LNG'),$.cookie('LAT'));
                    
                    }
                },500);
                
           }
           
           if(status=='office'){
              
                setTimeout(function(){
                    if($.cookie('LNG')!='' && $.cookie('LAT')!='' ){
                        
                        getMapDataBuilding(map.getZoom,$.cookie('PSNO'),$.cookie('JSNO'),$.cookie('TYNO'));
                        
                    
                }
                },500);
           }
          
          if($.cookie('KEYWORDS')!=''){
              var point=new BMap.Point($.cookie('LNG'),$.cookie('LAT'));        
            addBuildMarker($.cookie('KEYWORDS'),point,$.cookie('KEYWORDS'));
          }
           
           
       }else{
    
              
            
    
	$.ajax({
		type: "POST",
		data: {
			"xinan": getBounds()[0],
			"xibei": getBounds()[1],
			"dongbei": getBounds()[2],
			"dongnan": getBounds()[3],
			"zoom":limit,
			"psno":psno,
                        "jsno":jsno,
                        "tyno":tyno,
                        
                        //"r":200,
                        //默认显示距离为2000米以内的房源信息slor无法筛选
                        "station":opoint
                        
		},
		url: "http://www.ziroom.com/index.php?_p=map&_a=mapdata",
		dataType:"json",
		success: function(data) {
                  //  oMapLoading.hide();			
                    for(var i=0; i<data.length;i++){
                        
                            var txt = data[i].projectname;	
                            var projectcode = data[i].projectcode;
                            var lng = data[i].latitude;
                            var lat = data[i].longitude;
                            var point=new BMap.Point(lat,lng);                               
                            var house_counts = data[i].house_counts;
                            addMarker(txt,point,projectcode,house_counts);                                
                        
                           
                    }
                   
                    
                    
		}
		
	})//ajax end	
        
        if($.cookie('KEYWORDS')!=''){
              var point=new BMap.Point($.cookie('LNG'),$.cookie('LAT'));        
              addBuildMarker($.cookie('KEYWORDS'),point,$.cookie('KEYWORDS'));
          }
       
        /*
        if($.cookie('LNG')!='' && $.cookie('LAT')!='' ){
            var locations = $.cookie('LNG')+','+$.cookie('LAT');
            showBuildingMarkers('',$.cookie('KEYWORDS'),locations,map.getZoom,"yes");
         }*/

        
   
                    
        
    }
      ListShow();   
};

var buildInp = $('#i_q_keyword_2');
var buildError=$('#buildError');

$('.select_list .list li').click(function(){
  
   //$.cookie('KEYWORDS','');
    var _type = $(this).parents('ul').attr('data-type');
    var _val = $(this).find('a').attr('data-val');
    
    $(this).parents('ul').hide();
    $(this).addClass('active').siblings().removeClass('active');
    $(this).parents('ul').prev('h3').find('span').eq(0).html($(this).find('a').html());
    $.cookie(_type,_val);
    
    
    
    if(_type=='WALK_TIME' && buildInp.val()==''){
        buildError.show();
    }else{
       
        
        if(_type=='WALK_TIME'){
          
        }else{
            getMapData(map.getZoom,$.cookie('PSNO'),$.cookie('JSNO'),$.cookie('TYNO'));
           
        }
       
    }

   
    
});

buildInp.focus(function(){
    buildError.hide();
});

function addBuildMarker(t_txt,t_point,station_id){
   
    var myCompOverlay = new BuildOverlay(t_point, t_txt,station_id)
    map.addOverlay(myCompOverlay);
}
/*--------------------------------------楼盘自定义覆盖物类 begin-----------------------------------------*/
function BuildOverlay(point, text,station_id){
  this._point = point;
  this._text = text;
  this._station_id = station_id;
}
BuildOverlay.prototype = new BMap.Overlay();
BuildOverlay.prototype.initialize = function(map){
  this._map = map;
  var div = this._div = document.createElement("div");
  div.setAttribute("points",this._point.lng+','+this._point.lat);
  if($.cookie('station_id'))
  {
	 div.setAttribute("station_id",$.cookie('station_id'));
  }
  else
  {
  	  div.setAttribute("station_id",this._station_id);
  }
  div.style.position = "absolute";
  div.style.zIndex = BMap.Overlay.getZIndex(this._point.lat)+1000000;
  div.style.color = "#fff";
  div.style.height = "20px";
  div.style.padding = "0px 6px";
  div.style.lineHeight = "20px";
  div.style.whiteSpace = "nowrap";
  div.style.MozUserSelect = "none";
  div.style.fontSize = "12px";
  div.style.width = "200px";
  div.style.textAlign = "center";
  
  var that = this;

  var arrow = this._arrow = document.createElement("div");
  arrow.style.background = "url(/static/2015/images/map/img/msg.png)  no-repeat";
  arrow.style.position = "absolute";
  arrow.style.width = "8px";
  arrow.style.height = "4px";
  arrow.style.top = "20px";
  arrow.style.left = "50%";
  arrow.style.marginLeft = "-2px";
  arrow.style.zIndex = "10";
  
   var span = this._span = document.createElement("span");
  
  span.style.color = "#fff";
  span.style.background = "#f54336";
  span.style.display = "inline-block";
  span.style.height = "20px";
  span.style.borderRadius="3px";
  span.style.padding="0 5px";
  span.innerHTML=this._text ;
       
  div.appendChild(arrow);
  div.appendChild(span);
  
  map.getPanes().markerMouseTarget.appendChild(div);
  
  return div;
}
BuildOverlay.prototype.draw = function(){
  var map = this._map;
  var pixel = map.pointToOverlayPixel(this._point);
  this._div.style.left = pixel.x - 100 + "px";
  this._div.style.top  = pixel.y - 30 + "px";
}

/*---------------------------------------地铁站点自定义覆盖物类 end--------------------------------------------*/


function localSearch(t_value)
{
		var subwayline = $("#subwayList").find("dl");
		
		for(var k=1;k<subwayline.length;k++)
		{
		    var keyword1 = $("#subwayList").find("dl").eq(k).find('dt').find('a').html();
			if($.trim(keyword1)==$.trim(t_value))
			{
			    $("#subwayList").find("dl").eq(k).find('dt').find('a').trigger("click");
				return false;
			}
		}
		// 创建地址解析器实例
		removeMoveZoom();
		map.clearOverlays();
		isShowEvent = true;
		var myGeo = new BMap.Geocoder();
		// 将地址解析结果显示在地图上,并调整地图视野
		myGeo.getPoint(t_value, function(point){
                    if (point) 
                    {
                            setMoveZoom();
                            map.centerAndZoom(point, 16);
                            
                            $("#keyword").attr('keyword_point',point.lng+','+point.lat);
                            getMapData(14,$.cookie('PSNO'),$.cookie('JSNO'),$.cookie('TYNO'));


                    }
                    else
                    {

                    }
            }, //function end
            "北京市");
	}




$.cookie('BD_NAME','');
$.cookie('BD_LOCATION','');
$.cookie('BBD_NAME','');
$.cookie('BBD_LOCATION','');
$.cookie('subway_id','');
$.cookie('SUBWAYLINE_NAME','');
$.cookie('SUBWAY_LOCATION','');
$.cookie('station_id');
$.cookie('STATION_NAME','');
$.cookie('STATION_LOCATION','');
$.cookie('PSNO','');
$.cookie('JSNO','');
$.cookie('WALK_TIME','');
$.cookie('index_location','');
$.cookie('location_name','');
 $.cookie('Building_NAME');
$.cookie('KEYWORDS','');

    //联想词js
   
var buildError=$('#buildError');
$.cookie("WALK_TIME",'*');
 var walktime=0;     
var busTimes = new Array();
var Timenow = 0;   

    var step = -1;
    var oldValue="";
    var oMapLoading = $('#mapLoading');
    var oListLoading = $('#listLoading');
    var oMapAjaxBox = $('#ajaxbox_map'),
        oMapAjaxUl=oMapAjaxBox.find('ul'),
        aMapAjaxLi=oMapAjaxUl.find('li'),
        oBuildAjaxBox = $('#ajaxbox_build'),
        oBuildAjaxUl=oBuildAjaxBox.find('ul'),
        aBuildAjaxLi=oBuildAjaxUl.find('li'),
        oLoveAjaxBox = $('#ajaxbox_love'),
        oLoveAjaxUl=oLoveAjaxBox.find('ul'),
        aLoveAjaxLi=oLoveAjaxUl.find('li'),
        oKeyInpMap = $("#i_q_keyword_1"),
        oKeyInpBuild = $("#i_q_keyword_2"),
        oSearchMapBtn = $('#searchMapBtn'),
        oSearchBuildBtn = $('#searchBuildBtn'),
        oSearchFriendsBtn = $('#friends');
        
        
    $(document).click(function(){
        $(".t_ajaxbox").hide();
     });
         
     aBuildAjaxLi.live('click',function(){
         oKeyInpBuild.val($(this).find('span').text());
    });    
     
     //地图找房下拉框 
     //keyUpFn(oKeyInpMap,oMapAjaxBox,oSearchMapBtn,'map');
     //keyDownFn(oKeyInpMap,oMapAjaxBox,oSearchMapBtn,'map');
     //ajaxAjaxClick(oKeyInpMap,aMapAjaxLi,oSearchMapBtn,'map');
     
     //写字楼下拉框 
     //keyUpFn(oKeyInpBuild,oBuildAjaxBox,oSearchBuildBtn,'build');
     //keyDownFn(oKeyInpBuild,oBuildAjaxBox,oSearchBuildBtn,'build');
     //ajaxAjaxClick(oKeyInpBuild,oBuildAjaxBox,oSearchBuildBtn,'build');
     
     function keyUpFn(inp,box,btn,type){
          inp.keyup(function(ev){
		var oEvent=ev||event;
                var keyCode = oEvent.keyCode;
                var oTxt = $.trim(inp.val());
                if(oEvent.keyCode==38 || oEvent.keyCode==40)
                {
                    return;
                }

                if(oEvent.keyCode==13)
                {
                    btn.click();
                }
                var ajaxUrl='';
                if(type=='map'){
                    $.ajax({
			 type: "POST",
			 dataType:'json',
			 url: "/?_p=map&_a=suggest",
			 data: {wd:oTxt},
			 success: function(msg){
				if(msg.length==0)
				{
				  box.hide();
                                    return false;
				}
				var ulstr = '';

				box.find('ul').html(ulstr);
				for(var i=0;i<msg.length;i++)
				{
				  var goUrl = '';
				  var txt   = '';
				  if(msg[i].flag==1)
				  {//如果是地铁站

					  goUrl = "";
					  txt = msg[i].sublinename;
                                          names = msg[i].name;
				  }
				  else if(msg[i].flag==2)
				  {//如果是行政区
					  goUrl = "";
					  txt = msg[i].districtname;
                                          names = msg[i].bizcirclename;
			      }
				  else
				  {
					  goUrl = '';
					  txt = '';
				  }
				  ulstr+='<li data="'+goUrl+'"><span class="keyword" style="margin-right:5px;">'+names+'</span>';
				  ulstr+= txt;
				  
				}
				box.find('ul').html(ulstr).end().show();
			}
		});
                }
                if(type=='build'){
                    $.ajax({
                    type: "POST",
                    dataType:'json',
                    url: "/?_p=map&_a=suggestBuilding",
                    data: {wd:oTxt},
                    success: function(msg){

                        if(msg.length==0)
                        {
                            $(".t_ajaxbox").hide();
                            return false;
                        }
                        var ulstr = '';

                        box.find('ul').html(ulstr);
                        for(var i=0;i<msg.length;i++)
                        {
                            var goUrl = '';
                            var txt   = '';
                            if(msg[i].flag==1)
                            {//如果是地铁站

                                goUrl = "";
                                txt = msg[i].house_type;
                            }
                            else if(msg[i].flag==2)
                            {//如果是行政区
                            goUrl = "";
                            txt = msg[i].house_name;
                            }
                            else
                            {
                                goUrl = '';
                                txt = '';
                            }
                            ulstr+='<li data="'+goUrl+'"><span class="keyword" style="margin-right:5px;">'+msg[i].house_name+'</span>';
                            ulstr+= txt;

                        }	
                        box.find('ul').html(ulstr).end().show();
                        }
                    });
                }
		

            oldValue=oTxt;
            step=-1;
         });
     }
    

     function keyDownFn(inp,box,btn){
         inp.keydown(function(ev){
            var oEvent=ev||event;
            var keyCode = oEvent.keyCode;
            var aLi=box.find('li');
            if(oEvent.keyCode==40)  //↓
            {
                step++;

                if(step==aLi.length)            
                {
                    step=-1;
                }
                aLi.removeClass("keyhover");

                if(step!=-1)
                {
                    aLi.eq(step).addClass("keyhover");
                    inp.attr('_url',aLi.eq(step).attr('data'));
                    inp.val(aLi.eq(step).find(".keyword").text());
                }
                else
                {
                    inp.val(oldValue);
                    inp.attr('_url','');
                }
            }
            else if(oEvent.keyCode==38)
            {
                step--;

                if(step==-2)
                {
                    step=aLi.length-1;
                }

                aLi.removeClass("keyhover");

                if(step!=-1)
                {
                    box.eq(step).addClass("keyhover");
                    inp.attr('_url',aLi.eq(step).attr('data'));
                    inp.val(box.eq(step).find(".keyword").text());
                }
                else
                {
                    inp.val(oldValue);
                    inp.attr('_url','');
                }
            }
            if(oEvent.keyCode==38 || oEvent.keyCode==40)
            {
                return false;
            }
        });
     }

    
    function ajaxAjaxClick(inp,ajaxLi,btn){
        ajaxLi.live("click",function(){
	   var s_url = '';
          
	   if($(this).attr('data')!=''){
               s_url = $(this).attr('data');
            }
	   else{
               s_url = $(this).find(".keyword").text();
               inp.val(s_url);
            
           }
                
               
              
	   //window.location = s_url;
         
	 });
	 ajaxLi.live("mouseover mouseout",function(event){
		  ajaxLi.removeClass("keyhover");
		  if (event.type == 'mouseover') {
			$(this).addClass("keyhover");
			inp.attr('_url',$(this).attr('data'));
			step = $(this).index();
		  } else {
			$(this).removeClass("keyhover");
			inp.attr('_url','');
			step = $(this).index();
		  }
	 });
    }
   


   function  searchClick(inp){
      map.clearOverlays();
      var keywords = $(inp).val();
      $.cookie('KEYWORDS',keywords);
      
     
     if(inp=='#i_q_keyword_2' && keywords==''){
         buildError.show();
         $.cookie('KEYWORDS',oKeyInpBuild.val());
         return false;
    }
     // oMapLoading.show();
      
      
     
      
      
      if(inp=='#i_q_keyword_1'){
          var lng=$.cookie('LNG');
          var lat=$.cookie('LAT');
          var locations='';


           geoPointMarker('#i_q_keyword_1',$('#i_q_keyword_1').val(),function(){
             
               locations = $.cookie('LNG')+','+$.cookie('LAT');
               
              
            });

           setTimeout(function(){
            if(lng===$.cookie('LNG') && lat===$.cookie('LAT') && locations==''){
             //oMapLoading.hide();
            }else{
              showBuilding('',$.cookie('KEYWORDS'),locations,13,"yes");
            }
           },500);
           
        
    } 
    if(inp=='#i_q_keyword_2'){
       
         geoPointMarker('#i_q_keyword_2',$('#i_q_keyword_2').val(),function(){
             map.clearOverlays();
            var locations = $.cookie('LNG')+','+$.cookie('LAT');
            showBuildingMarkers('',$('#i_q_keyword_2').val(),locations,13,"yes");
           
        });
        
    }
       
  }


var gjTime =[];
//获取地图数据(写字楼)

function getMapDataBuilding(limit,psno,jsno,tyno)
{
        isShowEvent = false;
        //map.clearOverlays();
	if(limit>16) limit = '';
	else limit = 30;
       
        var timeVal=parseInt($.cookie("WALK_TIME"));//取得当前选的时间
        var timeHouse=[];//存小区名字
        var p1 = $.cookie('KEYWORDS');
        opoint = "building";//$.cookie('Building_NAME');//写字楼名称

         //  oMapLoading.show();
           
	   $.ajax({
		type: "POST",
		data: {
			"xinan": getBounds()[0],
			"xibei": getBounds()[1],
			"dongbei": getBounds()[2],
			"dongnan": getBounds()[3],
			"zoom":limit,
			"psno":psno,
                        "jsno":psno,
                        "tyno":psno,
                        
                        //"r":200,
                        //默认显示距离为2000米以内的房源信息slor无法筛选
                        "station":opoint
                        //"walktime":walktime
		},
		url: "http://www.ziroom.com/index.php?_p=map&_a=mapdata",
		dataType:"json",
		success: function(data) {
                    
			// oMapLoading.hide();
                         
                         if(data.length<=0){
                             
                            var keywords = $("#i_q_keyword_2").val();
                            var    _htmls="";
                             _htmls   += '<div class="none_msg">'
                                      +'<div class="tc"><img src="p.png"/*tpa=http://www.ziroom.com/static/2015/images/list/none/p.png*/></div>'
                                      +'<p class="fs16 mb40">很抱歉，没有找到与<span class="org">“'+keywords+'”</span>相关的房源</p>'
                                      +'<p>没有找到您想要的，快来换换其他写字楼吧！</p>'
                                      +'</div>';
                              oLeftList.html(_htmls);tempCounts
                         }
                         
                      
                             for(var i=0; i<data.length;i++){  
                        
				var txt = data[i].projectname;                             
				var house_counts=data[i].house_counts;
				var projectcode = data[i].projectcode;
				var lng = data[i].latitude;
				var lat = data[i].longitude;
				var point=new BMap.Point(lat,lng);
                                
                                
                                var timeVal=parseInt($.cookie("WALK_TIME"));
                                var tempCounts = 0;

                              
                                if(timeVal>0){
                                    
                                    setTimeMarker(p1,txt,txt,point,projectcode,house_counts);
                             
                                }else{
                                    addMarker(txt,point,projectcode,house_counts);  
                                }
                         }
                         
                        
                   
                     ListShow();  
                
                         
		},
		error: function(XMLHttpRequest, textStatus, errorThrown) {
			//alert(errorThrown)
		}
	})//ajax end	
       
       
      
       
       
        
}; 
 
function setTimeMarker(p1,p2,txt,point,projectcode,house_counts){
    var searchComplete = function (results){
     
        if (transit.getStatus() != BMAP_STATUS_SUCCESS){
                return ;
        }
        var plan = results.getPlan(0);
        var t = plan.getDuration(true);

           t = transitionTime(t);
           if(t<=$.cookie("WALK_TIME")){
                addMarker(txt,point,projectcode,house_counts); 
           }
    };

    var transit = new BMap.TransitRoute(map, {
       onSearchComplete: searchComplete
   });
    transit.search(p1,p2);   
}
 


//获取可视区域内所有楼盘的公交时间
function getBusTimesArray(){
    //获取可视区域内所有楼盘的公交时间
    var limit = '30';
    var walktime = $.cookie('WALK_TIME');//步行时间
    var opoint = "building"//$.cookie('Building_NAME');//写字楼名称
    var psno = "";
    gjTime =[];
    
  
   var p1 = $.cookie('KEYWORDS');
   
    $.ajax({
		type: "POST",
		data: {
			"xinan": getBounds()[0],
			"xibei": getBounds()[1],
			"dongbei": getBounds()[2],
			"dongnan": getBounds()[3],
			"zoom":limit,
			"psno":psno,
                        //"r":200,
                        //默认显示距离为2000米以内的房源信息slor无法筛选
                        "station":opoint
                        //"walktime":walktime
  
                        
		},
		url: "http://www.ziroom.com/index.php?_p=map&_a=mapdata",
		dataType:"json",
		success: function(data) {
			
			if(data.length==0) 
			{
			   //如果没有楼盘数据，不做赋值操作 
			}else{
                            //如果有楼盘则进行查询操作
                            for(var i=0; i<data.length;i++){
                                var lng = data[i].latitude;
				var lat = data[i].longitude;                                
                                var p2 = data[i].projectname;
                                
                                getGjTime($('#i_q_keyword_2').val(),p2);
                                
                            }
                           
                        }
                    },
	         error: function(XMLHttpRequest, textStatus, errorThrown) {
			//alert(errorThrown)
		}
                
	})//ajax end	
    
}





function transitionTime(s){
    
    var n,b,y,c;
    if(s.indexOf('小时')>0 && s.indexOf('分钟')>0){//有小时有分钟
        n = s.replace('小时',',');
        c = n.replace('分钟',' ');
        b =  c.split(',');
        y=parseInt(b[0]*60)+parseInt(b[1]); 
    }
    
    if(s.indexOf('小时')>0 && s.indexOf('分钟')<0){//有小时没分钟
        n = s.replace('小时','');
        y=parseInt(n*60); 
    }
    if(s.indexOf('小时')<0 && s.indexOf('分钟')>0){//没小时有分钟
        n = s.replace('分钟','');
        y = parseInt(n); 
    }
    return y;
}


//根据每两个点进行公交时间获取
function getGjTime(p1,p2){

    
    var searchComplete = function (results){
     
        if (transit.getStatus() != BMAP_STATUS_SUCCESS){
                return ;
        }
        var plan = results.getPlan(0);
        var t = plan.getDuration(true);
       // setTimeout(function(){
            t = transitionTime(t);
            gjTime.push(t);  //获取时间插入数组里面
           // console.log('p1='+p1+',p2='+p2+',时间为：'+t);
        //},10);

        
    };
    
    var transit = new BMap.TransitRoute(map, {
       onSearchComplete: searchComplete
   });
    transit.search(p1,p2);
    
   
}


function geoPointMarker(obj,str,fn){		
		
    // 将地址解析结果显示在地图上,并调整地图视野
    myGeo.getPoint(str, function(point){
            if (point) {
                    map.centerAndZoom(point, 14);	
                   
                    $(obj).attr({'data-lng':point.lng,'data-lat':point.lat});
                    $.cookie('LNG',point.lng);
                    $.cookie('LAT',point.lat); 
                    
                    if(fn){
                        fn();
                    }
                    
                    
            }else{
                //alert("您选择地址没有解析到结果!");
            }
    }, "北京市");

}
//清除覆盖物
function remove_overlay(){
    map.clearOverlays();         
}


oSearchFriendsBtn.click(function(){
    showLoverMarker();
})
        
//情侣找房的check
//$('.m3 .checkBox').click(function(){	

  //      oSearchFriendsBtn.click();


//})       
	
	//男生下拉提示
	var acMan = new BMap.Autocomplete(//建立一个自动完成的对象
		{"input" : "manVal"
		,"location" : map
	});
	//女生下拉提示
	var acWoman = new BMap.Autocomplete(//建立一个自动完成的对象
		{"input" : "womanVal"
		,"location" : map
	});
        
        //地图下拉提示
	var acMan = new BMap.Autocomplete(//建立一个自动完成的对象
		{"input" : "i_q_keyword_1"
		,"location" : map
	});
        
         //写字楼下拉提示
	var acMan = new BMap.Autocomplete(//建立一个自动完成的对象
		{"input" : "i_q_keyword_2"
		,"location" : map
	});
        
        
        
        
        $('#i_q_keyword_1').blur(function(){
            geoPointMarker(this,$(this).val());
            $.cookie('KEYWORDS',$(this).val());
        });
        
        
        
       
        